<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>–ò–ò-–∞–Ω–∞–ª–∏–∑ –ú–†–¢ | AlzAI</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.css" rel="stylesheet"/>
  <link rel="stylesheet" href="/style.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>

  <style>
    #removeBtn { display: none; }
    body { background: none; position: relative; }
    body::before { content: ""; position: fixed; inset: 0; background: url('/blue.png') center/cover no-repeat; z-index: -1; }

    .alz-card { border-radius: 20px; box-shadow: 0 12px 30px rgba(0,0,0,0.1); background: #fff; }
    h2 { letter-spacing: .5px; }
    #mriPreview { display: none; transition: opacity .5s ease; max-height: 280px; }
    .btn-alz { background: #2e72d2; color: #fff; border-radius: 8px; transition: background .3s; }
    .btn-alz:hover { background: #245bb2; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-light bg-white shadow-sm fixed-top">
    <div class="container">
      <a class="navbar-brand d-flex align-items-center" href="/index.html">
        <img src="/assets/memorycare1.jpeg" alt="AlzAI" height="38" class="me-2"/>
      </a>
    </div>
  </nav>

  <main class="pt-nav" style="min-height: calc(100vh - 78px); display: flex; align-items: center;">
    <div class="container">
      <div class="row justify-content-center">
        <div class="col-lg-6" data-aos="zoom-in">
          <div class="alz-card p-5" id="mriCard">
            <h2 class="fw-bold mb-4 text-center" data-aos="fade-down">–ò–ò-–∞–Ω–∞–ª–∏–∑ –ú–†–¢</h2>

            <form id="mriForm">
              <div class="mb-4" data-aos="fade-right">
                <label for="mriFile" class="form-label">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –ú–†–¢-—Å–Ω–∏–º–æ–∫</label>
                <input type="file" class="form-control" id="mriFile" accept=".jpg,.jpeg,.png,.dcm"/>
              </div>

              <div class="text-center mb-4" data-aos="fade-up">
                <img id="mriPreview" class="img-fluid rounded" alt="–ü—Ä–µ–≤—å—é"/>
                <button type="button" class="btn btn-outline-danger mt-2" id="removeBtn">–£–¥–∞–ª–∏—Ç—å</button>
              </div>

              <div class="d-grid" data-aos="fade-left">
                <button type="submit" id="analyzeBtn" class="btn btn-alz py-2">–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
              </div>
            </form>

            <div id="resultArea" class="alert mt-4 text-center d-none" role="alert"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
  <script>
    AOS.init({ once: true, duration: 700, easing: 'ease-out-cubic' });

    document.addEventListener('DOMContentLoaded', () => {
      const API_URL   = 'http://127.0.0.1:8000/predict'; // —ç–Ω–¥–ø–æ–∏–Ω—Ç FastAPI
      const fileInput = document.getElementById('mriFile');
      const preview   = document.getElementById('mriPreview');
      const removeBtn = document.getElementById('removeBtn');
      const analyzeBtn= document.getElementById('analyzeBtn');
      const resultArea= document.getElementById('resultArea');
      const form      = document.getElementById('mriForm');

      // –ü—Ä–µ–≤—å—é
      fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (file) {
          preview.src = URL.createObjectURL(file);
          preview.style.opacity = 0;
          preview.style.display = 'block';
          setTimeout(() => preview.style.opacity = 1, 50);
          removeBtn.style.display = 'inline-block';
        } else {
          preview.style.display = 'none';
          removeBtn.style.display = 'none';
        }
      });

      // –£–¥–∞–ª–µ–Ω–∏–µ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
      removeBtn.addEventListener('click', () => {
        fileInput.value = '';
        preview.style.display = 'none';
        removeBtn.style.display = 'none';
        resultArea.className = 'alert mt-4 text-center d-none';
        resultArea.innerHTML = '';
      });

      // –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
      form.addEventListener('submit', async (e) => {
        e.preventDefault();

        const file = fileInput.files[0];
        if (!file) {
          resultArea.className = 'alert alert-warning mt-4 text-center';
          resultArea.textContent = '‚ö†Ô∏è –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –ø–µ—Ä–µ–¥ –∞–Ω–∞–ª–∏–∑–æ–º.';
          resultArea.style.display = 'block';
          return;
        }

        analyzeBtn.disabled = true;
        resultArea.className = 'alert alert-info mt-4 text-center';
        resultArea.textContent = 'üí≠ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é...';
        resultArea.style.display = 'block';

        try {
          const formData = new FormData();
          formData.append('file', file, file.name);

          const res = await fetch(API_URL, { method: 'POST', body: formData });

          if (!res.ok) {
            const text = await res.text();
            resultArea.className = 'alert alert-danger mt-4 text-center';
            resultArea.textContent = `–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞ (${res.status}): ${text}`;
            return;
          }

          const data = await res.json();
          // –û–∂–∏–¥–∞–µ–º –æ—Ç API: { label, label_ru, prob }
          console.log('API JSON:', data);

          if (!('label' in data) || !('label_ru' in data) || !('prob' in data)) {
            resultArea.className = 'alert alert-danger mt-4 text-center';
            resultArea.textContent = '–ù–µ–æ–∂–∏–¥–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ API.';
            return;
          }

          const pct = (Number(data.prob) * 100).toFixed(1);

          resultArea.className = 'alert alert-success mt-4 text-center';

          if (data.label === "no_demented") {
            resultArea.innerHTML = `
              <h5>–†–µ–∑—É–ª—å—Ç–∞—Ç: ${data.label_ru}</h5>
              <p>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏: <strong>${pct}%</strong></p>
              <p>‚úÖ –ü–æ–∑–¥—Ä–∞–≤–ª—è–µ–º, –≤—Å—ë –≤ –ø–æ—Ä—è–¥–∫–µ!</p>
            `;
          } else {
            resultArea.innerHTML = `
              <h5>–†–µ–∑—É–ª—å—Ç–∞—Ç: ${data.label_ru}</h5>
              <p>–£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –º–æ–¥–µ–ª–∏: <strong>${pct}%</strong></p>
              <p>–ú—ã —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ–º –ø—Ä–æ–π—Ç–∏ –ø—Ä–æ–≥—Ä–∞–º–º—É –∫–æ–≥–Ω–∏—Ç–∏–≤–Ω–æ–≥–æ —Ä–∞–∑–≤–∏—Ç–∏—è –¥–ª—è –ø–ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∏ –∑–∞–º–µ–¥–ª–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∏—Ä–æ–≤–∞–Ω–∏—è:</p>
              <a href="/program.html" class="btn btn-primary mt-2">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–≥—Ä–∞–º–º–µ</a>
            `;
          }
        } catch (err) {
          resultArea.className = 'alert alert-danger mt-4 text-center';
          resultArea.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑–µ: ' + (err?.message || err);
        } finally {
          analyzeBtn.disabled = false;
        }
      });
    });
  </script>
</body>
</html>

